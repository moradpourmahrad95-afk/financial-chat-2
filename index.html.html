<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø§Ù„ÛŒâ€ŒÚ†Øª â€” Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', system-ui, sans-serif; background: #f7fafc; }
    .chat-scroll { max-height: 60vh; overflow:auto; }
    .bubble { white-space:pre-wrap; }
    /* custom small scrollbar for better UX */
    .chat-scroll::-webkit-scrollbar { width:8px; height:8px }
    .chat-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:8px }
  </style>
</head>
<body class="h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-6xl h-full bg-white shadow-lg rounded-2xl overflow-hidden grid grid-cols-1 md:grid-cols-3">
    <!-- Sidebar -->
    <aside class="col-span-1 md:col-span-1 border-l md:border-l-0 border-gray-100 p-4 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-lg font-semibold">ğŸ’¬ Ù…Ø§Ù„ÛŒâ€ŒÚ†Øª</h1>
        <button id="newChatBtn" class="text-sm bg-blue-600 text-white px-3 py-1 rounded-md">Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
      </div>

      <div class="flex-1 overflow-auto" id="chatsList">
        <!-- chat items injected here -->
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <div>Ø­Ø§ÙØ¸Ù‡: Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ (localStorage)</div>
        <div class="mt-2">Ù†Ú©ØªÙ‡: Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø­Ù„ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒØ¯ API Ù†Ø¯Ø§Ø±Ø¯.</div>
      </div>
    </aside>

    <!-- Main chat -->
    <main class="col-span-2 p-6 flex flex-col">
      <div class="mb-4 flex items-center justify-between">
        <div>
          <h2 id="chatTitle" class="text-2xl font-bold">Ø³Ù„Ø§Ù…! Ù…Ù† Ù…Ø§Ù„ÛŒâ€ŒÚ†Øª Ù‡Ø³ØªÙ… ğŸ¤</h2>
          <p id="chatSubtitle" class="text-sm text-gray-500">Ù‡Ø± Ø³ÙˆØ§Ù„ Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØ¯ Ø¨Ù¾Ø±Ø³ÛŒØ¯ â€” Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²ØŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="clearHistory" class="px-3 py-1 rounded border text-sm">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§</button>
        </div>
      </div>

      <div class="flex-1 border rounded-lg p-4 bg-gray-50 flex flex-col">
        <div id="messages" class="chat-scroll flex-1 space-y-3 mb-3" aria-live="polite">
          <!-- messages go here -->
        </div>

        <form id="inputForm" class="flex gap-3 items-end">
          <textarea id="userInput" rows="2" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯... (Ù…Ø«Ø§Ù„: Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ù…Ù† Ø±Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ú©Ù†)"></textarea>
          <div class="flex flex-col gap-2">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Ø§Ø±Ø³Ø§Ù„</button>
            <button type="button" id="actionPlanBtn" class="bg-yellow-500 text-black px-3 py-1 rounded-md text-sm">Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø§Ù„ÛŒ</button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Simple single-file "AI" assistant implemented in JS.
    // ØªÙ…Ø§Ù… Ù…ØªÙ†â€ŒÙ‡Ø§ ÙØ§Ø±Ø³ÛŒ Ø§Ø³Øª. Ú†Øªâ€ŒÙ‡Ø§ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§ØªÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡/Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¯Ø§Ø±Ø¯.

    // Utilities
    function $(sel){ return document.querySelector(sel) }
    function saveChats(chats){ localStorage.setItem('mali_chats_v1', JSON.stringify(chats)) }
    function loadChats(){ try{ return JSON.parse(localStorage.getItem('mali_chats_v1')) || [] }catch(e){ return [] } }

    // Default sample chat
    let chats = loadChats();
    if(!chats.length){
      chats = [{ id: Date.now(), title: 'Ú†Øª Ø§ÙˆÙ„', messages: [
        { role:'assistant', text: 'Ø³Ù„Ø§Ù…! Ù…Ù† Ù…Ø§Ù„ÛŒâ€ŒÚ†Øª Ù‡Ø³ØªÙ…. Ù‡Ø± Ø³ÙˆØ§Ù„ Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØ¯ Ø¨Ù¾Ø±Ø³ÛŒØ¯ â€” Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ø±Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ Ú©Ù…Ú© Ú©Ù†Ù….' }
      ]}];
      saveChats(chats);
    }

    let activeChatId = chats[0].id;

    // Render chat list
    function renderChatList(){
      const container = $('#chatsList'); container.innerHTML = '';
      chats.slice().reverse().forEach(chat => {
        const div = document.createElement('div');
        div.className = 'p-3 mb-2 rounded-lg cursor-pointer hover:bg-gray-100 flex items-center justify-between';
        div.innerHTML = `<div>
          <div class="font-medium">${escapeHtml(chat.title)}</div>
          <div class="text-xs text-gray-400">${chat.messages.length} Ù¾ÛŒØ§Ù…</div>
        </div>
        <div class="flex gap-2 items-center">
          <button data-id="${chat.id}" class="renameBtn text-xs text-blue-600">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
          <button data-id="${chat.id}" class="deleteBtn text-xs text-red-500">Ø­Ø°Ù</button>
        </div>`;
        div.addEventListener('click', (e)=>{
          const target = e.target;
          if(target.classList.contains('renameBtn') || target.classList.contains('deleteBtn')) return;
          setActiveChat(chat.id);
        });
        container.appendChild(div);
      });

      // attach delete / rename
      container.querySelectorAll('.deleteBtn').forEach(b=> b.addEventListener('click', (e)=>{
        e.stopPropagation(); const id = Number(b.dataset.id); if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú†Øª Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) return;
        chats = chats.filter(c=>c.id!==id); saveChats(chats); if(chats.length) setActiveChat(chats[0].id); else { chats = []; saveChats(chats); location.reload(); }
      }));
      container.querySelectorAll('.renameBtn').forEach(b=> b.addEventListener('click', (e)=>{
        e.stopPropagation(); const id = Number(b.dataset.id); const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ú†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'); if(!newName) return; const ch = chats.find(c=>c.id===id); ch.title = newName; saveChats(chats); renderChatList(); if(id===activeChatId) $('#chatTitle').textContent = newName;
      }));
    }

    function escapeHtml(text){ return text.replace(/[&<>\"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m] }) }

    // Render active chat
    function renderActiveChat(){
      const chat = chats.find(c=>c.id===activeChatId);
      if(!chat) return;
      $('#chatTitle').textContent = chat.title || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
      const msgs = $('#messages'); msgs.innerHTML = '';
      chat.messages.forEach(m => {
        const wrapper = document.createElement('div');
        if(m.role==='assistant'){
          wrapper.className = 'self-start max-w-xl bg-white p-3 rounded-xl shadow-sm';
          wrapper.innerHTML = `<div class="bubble text-sm">${escapeHtml(m.text)}</div>`;
        } else {
          wrapper.className = 'self-end max-w-xl bg-green-600 text-white p-3 rounded-xl ml-auto';
          wrapper.innerHTML = `<div class="bubble text-sm">${escapeHtml(m.text)}</div>`;
        }
        msgs.appendChild(wrapper);
      });
      msgs.scrollTop = msgs.scrollHeight;
    }

    function setActiveChat(id){ activeChatId = id; renderChatList(); renderActiveChat(); }

    // Simple Persian/number parsing helpers
    function parsePersianNumber(str){
      if(!str) return null;
      str = str.replace(/Ù¬|,/g,'').trim();
      const persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      for(let i=0;i<10;i++) str = str.replace(new RegExp(persianDigits[i],'g'), String(i));
      const m = str.match(/-?\d+(?:\.\d+)?/);
      return m ? Number(m[0]) : null;
    }

    // Very simple "AI": rule-based responder for common finance tasks.
    function assistantReply(userText){
      const text = userText.toLowerCase();

      // Greetings
      if(/Ø³Ù„Ø§Ù…|Ø¯Ø±ÙˆØ¯|hi|Ø³Ù„Ø§Ù…ÛŒ/.test(text)) return 'Ø³Ù„Ø§Ù…! Ú†Ù‡ Ú©Ù…Ú©ÛŒ Ø§Ø² Ø¯Ø³Øª Ù…Ø§Ù„ÛŒâ€ŒÚ†Øª Ø¨Ø±Ù…ÛŒØ§Ø¯ØŸ Ù„Ø·ÙØ§Ù‹ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯ Ù†ÛŒØ§Ø²ØªØ§Ù† Ú†ÛŒØ³Øª: Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²ØŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ ÛŒØ§ Ù…Ø´Ø§ÙˆØ±Ù‡ Ú©Ù„ÛŒ.';

      // Budget planner intent
      if(/Ø¨ÙˆØ¯Ø¬Ù‡|Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ|Ø¨ÙˆØ¯Ø¬Ù‡ Ø±|Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡|Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡/.test(text)){
        // try to extract income and major expenses
        const nums = (text.match(/-?\d+[\d\.,Û°-Û¹]*/g) || []).map(s=>parsePersianNumber(s)).filter(n=>!isNaN(n));
        if(nums.length>=1){
          const income = nums[0];
          // heuristic expenses sum: take other numbers as expenses
          const expenses = nums.slice(1);
          const sumExpenses = expenses.reduce((a,b)=>a+(b||0),0);
          const recommendedSavings = Math.max(0, income - sumExpenses);
          const savingRate = ((recommendedSavings/income)*100).toFixed(1);
          return `Ø·Ø¨Ù‚ Ø§Ø¹Ø¯Ø§Ø¯ ÛŒØ§ÙØªâ€ŒØ´Ø¯Ù‡:
- Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡: ${income.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†
- Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: ${sumExpenses.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø­Ø¯Ø§Ù‚Ù„ ${Math.round(Math.min(0.3, recommendedSavings/income||0)*100)}% Ø§Ø² Ø¯Ø±Ø¢Ù…Ø¯ Ø±Ø§ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ú©Ù†ÛŒØ¯. (Ø¨Ø±Ø§Ø³Ø§Ø³ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù¾Ø§ÛŒÙ‡). Ù…Ø§Ù†Ø¯Ù‡Ù” Ù‚Ø§Ø¨Ù„ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø­Ø¯ÙˆØ¯ ${recommendedSavings.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª.`;
        } else {
          return 'Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù„Ø·ÙØ§Ù‹ Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒâ€ŒØªØ§Ù† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯. Ù…Ø«Ø§Ù„: "Ø¯Ø±Ø¢Ù…Ø¯ Û³Û° Ù…ÛŒÙ„ÛŒÙˆÙ†ØŒ Ø§Ø¬Ø§Ø±Ù‡ Û±Û° Ù…ÛŒÙ„ÛŒÙˆÙ†ØŒ Ù‚Ø¨ÙˆØ¶ Û² Ù…ÛŒÙ„ÛŒÙˆÙ†".';
        }
      }

      // Savings goal intent
      if(/Ù¾Ø³.?Ø§Ù†Ø¯Ø§Ø²|Ù‡Ø¯Ù Ù¾Ø³.?Ø§Ù†Ø¯Ø§Ø²|Ù‡Ø¯Ù Ù¾Ø³ Ø§Ù†Ø¯Ø§Ø²|Ø°Ø®ÛŒØ±Ù‡/.test(text)){
        // look for target and period and current saving
        const nums = (text.match(/-?\d+[\d\.,Û°-Û¹]*/g) || []).map(s=>parsePersianNumber(s)).filter(n=>!isNaN(n));
        if(nums.length>=2){
          const target = nums[0];
          const months = nums[1];
          const monthly = Math.ceil(target/months);
          return `Ø¨Ø±Ø§ÛŒ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù‡Ø¯Ù ${target.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ø¯Ø± ${months} Ù…Ø§Ù‡ØŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª Ù‡Ø± Ù…Ø§Ù‡ Ø­Ø¯Ø§Ù‚Ù„ ${monthly.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ú©Ù†Ø§Ø± Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯.`;
        } else {
          return 'Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø¯Ù Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯. Ù…Ø«Ø§Ù„: "Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Û¶Û° Ù…ÛŒÙ„ÛŒÙˆÙ† Ø¯Ø± Û±Û² Ù…Ø§Ù‡ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ú©Ù†Ù…".';
        }
      }

      // Investment simple advice
      if(/Ø³Ø±Ù…Ø§ÛŒÙ‡|Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ|Ø³Ø±Ù…Ø§ÙŠÙ‡/.test(text)){
        return 'Ø¨Ø±Ø§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø¨ØªØ¯Ø§ Ø³Ø·Ø­ Ø±ÛŒØ³Ú©ØŒ Ø§ÙÙ‚ Ø²Ù…Ø§Ù†ÛŒ Ùˆ Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„â€ŒØ³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ø¯Ù†Ø¨Ø§Ù„ Ú¯Ø²ÛŒÙ†Ù‡Ù” Ú©Ù…â€ŒØ±ÛŒØ³Ú© Ù‡Ø³ØªÛŒØ¯: Ø³Ù¾Ø±Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª ÛŒØ§ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¯Ø±Ø¢Ù…Ø¯ Ø«Ø§Ø¨ØªØ› Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª/Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª: ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø³Ù‡Ø§Ù…ÛŒ ÛŒØ§ ØªØ±Ú©ÛŒØ¨ÛŒ. Ù…Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø¯Ù‡Ù” ØªØ®ØµÛŒØµ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ù‡Ù… Ø§Ú¯Ø± Ù…Ø¨Ù„Øº Ùˆ Ø§ÙÙ‚â€ŒØªØ§Ù† Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒØ¯.';
      }

      // Loan / debt
      if(/Ù‚Ø±Ø¶|ÙˆØ§Ù…|Ø§Ù‚Ø³Ø§Ø·/.test(text)){
        const nums = (text.match(/-?\d+[\d\.,Û°-Û¹]*/g) || []).map(s=>parsePersianNumber(s)).filter(n=>!isNaN(n));
        if(nums.length>=2){
          const principal = nums[0];
          const months = nums[1];
          // assume example rate 18% annual
          const annualRate = 0.18;
          const monthlyRate = annualRate/12;
          const payment = Math.ceil((principal * monthlyRate) / (1 - Math.pow(1+monthlyRate, -months)));
          return `Ø¨Ø±Ø§ÛŒ ÙˆØ§Ù… ${principal.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ø¯Ø± ${months} Ù…Ø§Ù‡ Ø¨Ø§ Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡Ù” ÙØ±Ø¶ÛŒ ${Math.round(annualRate*100)}%ØŒ Ù‚Ø³Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø­Ø¯ÙˆØ¯ ${payment.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯. (Ø§ÛŒÙ† Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³Øª.)`;
        } else {
          return 'Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ù‚Ø³Ø·ØŒ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù…Ø«Ø§Ù„: "ÙˆØ§Ù… Û²Û° Ù…ÛŒÙ„ÛŒÙˆÙ† Ø¨Ø±Ø§ÛŒ Û²Û´ Ù…Ø§Ù‡".';
        }
      }

      // If user asks to create plan explicitly
      if(/Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡|Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø§Ù„ÛŒ|Ù¾Ù„Ù†/.test(text)){
        return 'Ø®ÙˆØ¨Ù‡! Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù…Ø§Ù„ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯: Û±) Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†) Û²) Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†) Û³) Ø§Ù‡Ø¯Ø§Ù (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù†Ù‡ Ø¯Ø± Û³Û¶ Ù…Ø§Ù‡ Ø¨Ø§ Ù…Ø¨Ù„Øº X)';
      }

      // If user asks for explanation/simple tips
      if(/Ù†Ú©ØªÙ‡|ØªÙˆØµÛŒÙ‡|Ù…Ø´Ø§ÙˆØ±Ù‡/.test(text)){
        return 'Ú†Ù†Ø¯ Ù†Ú©ØªÙ‡Ù” Ú©Ù„ÛŒ:
1) 50/30/20: Ø­Ø¯ÙˆØ¯ ÛµÛ°Ùª Ø¨Ø±Ø§ÛŒ Ù†ÛŒØ§Ø²Ù‡Ø§ØŒ Û³Û°Ùª Ø®ÙˆØ§Ø³ØªÙ‡â€ŒÙ‡Ø§ØŒ Û²Û°Ùª Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²/Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ.
2) ØµÙ†Ø¯ÙˆÙ‚ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ù…Ø¹Ø§Ø¯Ù„ Û³-Û¶ Ù…Ø§Ù‡ Ù‡Ø²ÛŒÙ†Ù‡Ù” Ø«Ø§Ø¨Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.
3) Ù‚Ø¨Ù„ Ø§Ø² Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒØŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ù‡Ø²ÛŒÙ†Ù‡ (Ù…Ø«Ù„ Ú©Ø§Ø±Øªâ€ŒØ§Ø¹ØªØ¨Ø§Ø±ÛŒ Ø¨Ø§ Ù†Ø±Ø® Ø¨Ø§Ù„Ø§) Ø±Ø§ Ú©Ù… Ú©Ù†ÛŒØ¯.';
      }

      // Fallback: try to do a light generative answer by pattern
      return `Ù…ØªÙ† Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: "${userText}"\nÙ…Ù† ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù… â€” Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ù…Ø´Ø®Øµ Ø¨Ø³Ø§Ø²Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ "Ø¨Ø±Ù†Ø§Ù…Ù‡" Ùˆ Ø§Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯Ù†ÛŒØ§Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¯Ø±Ø¢Ù…Ø¯ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ù‡Ø¯Ù Ùˆ Ù…Ø¯Øª).`;
    }

    // Adding messages to chat
    function addMessageToActive(role, text){
      const chat = chats.find(c=>c.id===activeChatId);
      if(!chat) return;
      chat.messages.push({ role, text }); saveChats(chats); renderActiveChat(); renderChatList();
    }

    // Handle user submission
    $('#inputForm').addEventListener('submit', function(e){
      e.preventDefault(); const input = $('#userInput'); const text = input.value.trim(); if(!text) return;
      addMessageToActive('user', text);
      input.value = '';
      // simple simulated delay
      setTimeout(()=>{
        const reply = assistantReply(text);
        addMessageToActive('assistant', reply);
      }, 350);
    });

    // Action plan button starts a guided flow
    $('#actionPlanBtn').addEventListener('click', ()=>{
      const step1 = prompt('Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'); if(!step1) return;
      const income = parsePersianNumber(step1);
      const step2 = prompt('Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (Ø¬Ù…Ø¹) (ØªÙˆÙ…Ø§Ù†) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'); if(!step2) return;
      const expenses = parsePersianNumber(step2);
      const step3 = prompt('Ø¢ÛŒØ§ Ù‡Ø¯Ù Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ (Ù…Ø«Ù„Ø§Ù‹: Ø¬Ù…Ø¹ X Ø¯Ø± Y Ù…Ø§Ù‡) â€” Ø§Ú¯Ø± Ù†Ø¯Ø§Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯.');
      addMessageToActive('user', `Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡: Ø¯Ø±Ø¢Ù…Ø¯ ${income||step1}ØŒ Ù‡Ø²ÛŒÙ†Ù‡ ${expenses||step2}ØŒ Ù‡Ø¯Ù: ${step3||'Ù†Ø¯Ø§Ø±Ø¯'}`);
      // compute simple plan
      const disposable = Math.max(0, (income||0) - (expenses||0));
      let reply = `Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:
- Ø¯Ø±Ø¢Ù…Ø¯: ${(income||0).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†
- Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª: ${(expenses||0).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†
- Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªØ®ØµÛŒØµ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²/Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: ${disposable.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\n`;
      if(step3 && /\d/.test(step3)){
        // try to extract numbers for goal
        const nums = (step3.match(/-?\d+[\d\.,Û°-Û¹]*/g)||[]).map(s=>parsePersianNumber(s)).filter(n=>!isNaN(n));
        if(nums.length>=2){
          const target = nums[0]; const months = nums[1]; const perMonth = Math.ceil(target/months);
          reply += `Ù‡Ø¯Ù: ${target.toLocaleString('fa-IR')} Ø¯Ø± ${months} Ù…Ø§Ù‡ â†’ Ù†ÛŒØ§Ø² Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡: ${perMonth.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\n`;
          if(perMonth>disposable) reply += 'ØªÙˆØ¬Ù‡: Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ù‡Ø¯Ù Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªØ®ØµÛŒØµ ÙØ¹Ù„ÛŒ Ø§Ø³Øª. ÛŒØ§ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ù…Ø¯Øª Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯.';
        }
      }
      addMessageToActive('assistant', reply);
    });

    // New chat
    $('#newChatBtn').addEventListener('click', ()=>{
      const newChat = { id: Date.now(), title: 'Ú†Øª Ø¬Ø¯ÛŒØ¯', messages: [{ role:'assistant', text: 'Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯. Ú†Ù‡ Ú©Ù…Ú©ÛŒ Ø§Ø² Ù…Ù† Ø¨Ø±Ù…ÛŒâ€ŒØ¢ÛŒØ¯ØŸ' }] };
      chats.push(newChat); saveChats(chats); setActiveChat(newChat.id);
    });

    // Clear history
    $('#clearHistory').addEventListener('click', ()=>{
      if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡Ù” Ú†Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) return;
      localStorage.removeItem('mali_chats_v1'); chats = []; location.reload();
    });

    // Initial render
    renderChatList(); renderActiveChat();

    // Accessibility: focus textarea on load
    $('#userInput').focus();
  </script>
</body>
</html>
